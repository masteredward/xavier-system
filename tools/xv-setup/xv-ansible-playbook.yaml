---
- name: Xavier System Setup
  hosts: localhost
  connection: local

  tasks:
  - name: Ensure Xavier System directory structure
    ansible.builtin.file:
      path: "{{ item.path }}"
      state: directory
      mode: 0755
      owner: root
      group: root
    loop:
    - path: /host/opt/xavier/root
    - path: /host/opt/xavier/root/.ssh
    - path: /host/opt/xavier/root/bin
    - path: /host/opt/xavier/sources
    - path: /host/opt/xavier/tools
    - path: /host/opt/xavier/workspace

  - name: Install/Update oh-my-zsh
    ansible.builtin.git:
      repo: https://github.com/ohmyzsh/ohmyzsh.git
      dest: /host/opt/xavier/root/.oh-my-zsh
      single_branch: yes
      force: yes
      depth: 1

  - name: Copy .zshrc from oh-my-zsh default template (no overwrite)
    ansible.builtin.copy:
      src: /host/opt/xavier/root/.oh-my-zsh/templates/zshrc.zsh-template
      dest: /host/opt/xavier/root/.zshrc
      force: no
      owner: root
      group: root
      mode: 0644

  - name: Install/Update powerlevel10k oh-my-zsh theme
    ansible.builtin.git:
      repo: https://github.com/romkatv/powerlevel10k.git
      dest: /host/opt/xavier/root/.oh-my-zsh/custom/themes/powerlevel10k
      single_branch: yes
      force: yes
      depth: 1

  - name: Set oh-my-zsh theme to powerlevel10k
    ansible.builtin.replace:
      path: /host/opt/xavier/root/.zshrc
      regexp: '(^ZSH_THEME=\")\S+(\")'
      replace: '\1powerlevel10k/powerlevel10k\2'

  - name: Install/Update zsh-autosuggestions oh-my-zsh plugin
    ansible.builtin.git:
      repo: https://github.com/zsh-users/zsh-autosuggestions.git
      dest: /host/opt/xavier/root/.oh-my-zsh/custom/plugins/zsh-autosuggestions
      single_branch: yes
      force: yes
      depth: 1

  - name: Install/Update zsh-syntax-highlighting oh-my-zsh plugin
    ansible.builtin.git:
      repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
      dest: /host/opt/xavier/root/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting
      single_branch: yes
      force: yes
      depth: 1

  - name: Set oh-my-zsh plugins
    ansible.builtin.replace:
      path: /host/opt/xavier/root/.zshrc
      regexp: '(^plugins=\()\S+(\))'
      replace: '\1git history-substring-search zsh-autosuggestions zsh-syntax-highlighting\2'

  - name: Copy host authorized_keys from ec2-user into Xavier System
    ansible.builtin.copy:
      src: /host/home/ec2-user/.ssh/authorized_keys
      dest: /host/opt/xavier/root/.ssh/authorized_keys
      owner: root
      group: root
      mode: 0600

  - name: Install xv script
    ansible.builtin.copy:
      src: /host/opt/xavier/system/tools/xv-setup/xv.sh
      dest: /host/usr/local/bin/xv
      owner: root
      group: root
      mode: 0755

  - name: Install fake aws-cli script
    ansible.builtin.copy:
      src: /host/opt/xavier/system/tools/scripts/aws
      dest: /host/opt/xavier/root/bin/aws
      owner: root
      group: root
      mode: 0755

  - name: Build xv container tool
    ansible.builtin.shell: chroot /host /bin/bash -c "docker build /opt/xavier/system/tools/xv/ -t xv"